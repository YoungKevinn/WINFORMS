using System;
using System.Collections.Generic;
using System.Drawing;
using System.Linq;
using System.Text;
using System.Windows.Forms;
using Client_DoMInhKhoa.Models;
using Client_DoMInhKhoa.Services;

namespace Client_DoMInhKhoa.Forms
{
    public partial class FormQuanLyBan : Form
    {
        // ====== UI controls ======
        private Panel panelTitle;
        private Label lblTitle;

        private Panel panelFilter;
        private Button btnFilterAll;
        private Button btnFilterTrong;
        private Button btnFilterDangPhucVu;
        private Label lblThongKe;

        // DÙ tên là panelTables nhưng thực tế là FlowLayoutPanel
        private Panel panelTables;   // sẽ new FlowLayoutPanel

        private Panel panelBottom;
        private Label lblBanFrom;
        private ComboBox cboBanFrom;
        private Label lblBanTo;
        private ComboBox cboBanTo;
        private Button btnChuyenBan;
        private Button btnGopBan;

        private ContextMenuStrip menuTrangThai;

        // ====== Services + dữ liệu thật ======
        private readonly DonGoiService _donGoiService = new();
        private readonly ChiTietDonGoiService _ctDonGoiService = new();
        private readonly ThucAnService _thucAnService = new();
        private readonly ThucUongService _thucUongService = new();

        private readonly List<BanViewModel> _allBans = new();
        private readonly Dictionary<BanViewModel, Button> _banButtons = new();

        private List<ThucAnDto> _dsThucAn = new();
        private List<ThucUongDto> _dsThucUong = new();

        private enum BanStatus { Trong, DangPhucVu }
        private enum FilterMode { TatCa, Trong, DangPhucVu }

        private FilterMode _currentFilter = FilterMode.TatCa;
        private BanViewModel? _banDangChon;
        private Button? _activeFilterButton;

        // ViewModel 1 bàn
        private class BanViewModel
        {
            public int Id { get; set; }
            public string TenBan { get; set; } = "";
            public BanStatus TrangThai { get; set; }

            // Đơn đang mở (TrangThai = 0) nếu có
            public DonGoiDto? DonGoiDangMo { get; set; }

            public override string ToString() =>
                string.IsNullOrWhiteSpace(TenBan) ? $"Bàn {Id}" : TenBan;
        }

        // ===========================================================
        // CTOR
        // ===========================================================
        public FormQuanLyBan()
        {
            Text = "Quản lý bàn";
            StartPosition = FormStartPosition.CenterScreen;
            ClientSize = new Size(1000, 600);
            Font = new Font("Segoe UI", 10f, FontStyle.Regular);
            BackColor = Color.White;
            AutoScaleMode = AutoScaleMode.None;

            // giảm flicker
            SetStyle(ControlStyles.OptimizedDoubleBuffer |
                     ControlStyles.AllPaintingInWmPaint |
                     ControlStyles.UserPaint, true);

            BuildLayout();
            AttachEvents();
        }

        // ===========================================================
        // 1. XÂY DỰNG UI
        // ===========================================================
        private void BuildLayout()
        {
            // ----- TITLE -----
            panelTitle = new Panel
            {
                Dock = DockStyle.Top,
                Height = 60,
                BackColor = Color.White
            };

            lblTitle = new Label
            {
                Text = "QUẢN LÝ BÀN",
                Dock = DockStyle.Fill,
                Font = new Font("Segoe UI", 18, FontStyle.Bold),
                TextAlign = ContentAlignment.MiddleLeft,
                Padding = new Padding(20, 0, 0, 0)
            };
            panelTitle.Controls.Add(lblTitle);

            // ----- FILTER -----
            panelFilter = new Panel
            {
                Dock = DockStyle.Top,
                Height = 50,
                BackColor = Color.FromArgb(245, 247, 250)
            };

            btnFilterAll = new Button
            {
                Text = "Tất cả",
                Width = 80,
                Height = 32,
                Location = new Point(20, 9)
            };
            btnFilterTrong = new Button
            {
                Text = "Còn trống",
                Width = 90,
                Height = 32,
                Location = new Point(110, 9)
            };
            btnFilterDangPhucVu = new Button
            {
                Text = "Đang dùng",
                Width = 90,
                Height = 32,
                Location = new Point(210, 9)
            };

            lblThongKe = new Label
            {
                AutoSize = true,
                Location = new Point(320, 15),
                Font = new Font("Segoe UI", 9, FontStyle.Italic),
                ForeColor = Color.Gray
            };

            panelFilter.Controls.AddRange(new Control[]
            {
                btnFilterAll, btnFilterTrong, btnFilterDangPhucVu, lblThongKe
            });

            // ----- PANEL BÀN (LƯỚI) -----
            var flp = new FlowLayoutPanel
            {
                Dock = DockStyle.Fill,
                BackColor = Color.White,
                AutoScroll = true,
                WrapContents = true,
                FlowDirection = FlowDirection.LeftToRight,
                Padding = new Padding(40, 40, 40, 40)
            };
            flp.DoubleBuffered(true);
            panelTables = flp;

            // ----- BOTTOM: chuyển / gộp bàn -----
            panelBottom = new Panel
            {
                Dock = DockStyle.Bottom,
                Height = 60,
                BackColor = Color.White
            };

            lblBanFrom = new Label
            {
                Text = "Bàn nguồn:",
                AutoSize = true,
                Location = new Point(20, 20)
            };
            cboBanFrom = new ComboBox
            {
                Location = new Point(100, 16),
                Width = 130,
                DropDownStyle = ComboBoxStyle.DropDownList
            };

            lblBanTo = new Label
            {
                Text = "Bàn đích:",
                AutoSize = true,
                Location = new Point(250, 20)
            };
            cboBanTo = new ComboBox
            {
                Location = new Point(320, 16),
                Width = 130,
                DropDownStyle = ComboBoxStyle.DropDownList
            };

            btnChuyenBan = new Button
            {
                Text = "Chuyển bàn",
                Width = 100,
                Height = 30,
                Location = new Point(470, 15)
            };

            btnGopBan = new Button
            {
                Text = "Gộp bàn",
                Width = 100,
                Height = 30,
                Location = new Point(580, 15)
            };

            panelBottom.Controls.AddRange(new Control[]
            {
                lblBanFrom, cboBanFrom,
                lblBanTo, cboBanTo,
                btnChuyenBan, btnGopBan
            });

            // ----- MENU TRẠNG THÁI (right-click) -----
            menuTrangThai = new ContextMenuStrip();
            var itemTrong = new ToolStripMenuItem("Để trống") { Tag = BanStatus.Trong };
            var itemPhucVu = new ToolStripMenuItem("Đang phục vụ") { Tag = BanStatus.DangPhucVu };
            itemTrong.Click += MenuTrangThai_Click;
            itemPhucVu.Click += MenuTrangThai_Click;
            menuTrangThai.Items.AddRange(new ToolStripItem[] { itemTrong, itemPhucVu });

            // ====== THỨ TỰ DOCK ======
            Controls.Add(panelTables);   // Fill
            Controls.Add(panelBottom);   // Bottom
            Controls.Add(panelFilter);   // Top 2
            Controls.Add(panelTitle);    // Top 1
        }

        private void AttachEvents()
        {
            Load += FormQuanLyBan_Load;

            btnFilterAll.Click += (s, e) =>
            {
                SetActiveFilter(btnFilterAll);
                _currentFilter = FilterMode.TatCa;
                ApplyFilter();
            };
            btnFilterTrong.Click += (s, e) =>
            {
                SetActiveFilter(btnFilterTrong);
                _currentFilter = FilterMode.Trong;
                ApplyFilter();
            };
            btnFilterDangPhucVu.Click += (s, e) =>
            {
                SetActiveFilter(btnFilterDangPhucVu);
                _currentFilter = FilterMode.DangPhucVu;
                ApplyFilter();
            };

            btnChuyenBan.Click += BtnChuyenBan_Click;
            btnGopBan.Click += BtnGopBan_Click;
        }

        // ===========================================================
        // 2. LOAD DỮ LIỆU THẬT TỪ DB
        // ===========================================================
        private async void FormQuanLyBan_Load(object? sender, EventArgs e)
        {
            await LoadDataAsync();
        }

        private async Task LoadDataAsync()
        {
            try
            {
                // 1. Lấy danh sách bàn
                var dsBan = await BanService.GetAllAsync();

                // 2. Lấy danh sách đơn gọi + món để biết đơn đang mở
                var dsDonGoi = await _donGoiService.GetAllAsync();

                // 3. Cache tên món để hiện trong chi tiết
                _dsThucAn = await _thucAnService.GetAllAsync();
                _dsThucUong = await _thucUongService.GetAllAsync();

                _allBans.Clear();

                foreach (var ban in dsBan.OrderBy(b => b.Id))
                {
                    var donDangMo = dsDonGoi
                        .Where(d => d.BanId == ban.Id && d.TrangThai == 0)
                        .OrderByDescending(d => d.MoLuc)
                        .FirstOrDefault();

                    var vm = new BanViewModel
                    {
                        Id = ban.Id,
                        TenBan = ban.TenBan,
                        TrangThai = ban.TrangThai == 1
                            ? BanStatus.DangPhucVu
                            : BanStatus.Trong,
                        DonGoiDangMo = donDangMo
                    };

                    _allBans.Add(vm);
                }

                BuildButtons();
                BindCombos();

                SetActiveFilter(btnFilterAll);
                _currentFilter = FilterMode.TatCa;
                ApplyFilter();
            }
            catch (Exception ex)
            {
                MessageBox.Show("Lỗi khi load dữ liệu bàn: " + ex.Message,
                    "Lỗi", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        private void BuildButtons()
        {
            panelTables.Controls.Clear();
            _banButtons.Clear();

            foreach (var ban in _allBans.OrderBy(b => b.Id))
            {
                var btn = CreateBanButton(ban);
                _banButtons[ban] = btn;
                panelTables.Controls.Add(btn);
            }
        }

        private void BindCombos()
        {
            cboBanFrom.Items.Clear();
            cboBanTo.Items.Clear();

            foreach (var ban in _allBans)
            {
                cboBanFrom.Items.Add(ban);
                cboBanTo.Items.Add(ban);
            }

            if (cboBanFrom.Items.Count > 0)
                cboBanFrom.SelectedIndex = 0;
            if (cboBanTo.Items.Count > 1)
                cboBanTo.SelectedIndex = 1;
        }

        // ===========================================================
        // 3. FILTER
        // ===========================================================
        private bool MatchCurrentFilter(BanViewModel ban)
        {
            return _currentFilter switch
            {
                FilterMode.Trong => ban.TrangThai == BanStatus.Trong,
                FilterMode.DangPhucVu => ban.TrangThai == BanStatus.DangPhucVu,
                _ => true,
            };
        }

        private void ApplyFilter()
        {
            var filtered = _allBans.Where(MatchCurrentFilter)
                                   .OrderBy(b => b.Id)
                                   .ToList();

            foreach (var kv in _banButtons)
            {
                bool show = filtered.Contains(kv.Key);
                kv.Value.Visible = show;
            }

            UpdateThongKeLabel(filtered.Count);
        }

        private Button CreateBanButton(BanViewModel ban)
        {
            string displayName = string.IsNullOrWhiteSpace(ban.TenBan)
                ? $"BÀN {ban.Id}"
                : ban.TenBan.ToUpperInvariant();

            var btn = new Button
            {
                Text = displayName,
                Tag = ban,
                FlatStyle = FlatStyle.Flat,
                Font = new Font("Segoe UI", 11, FontStyle.Bold),
                TextAlign = ContentAlignment.MiddleCenter,
                Width = 150,
                Height = 90,
                Margin = new Padding(20)
            };
            btn.FlatAppearance.BorderSize = 2;

            ApplyColorByStatus(btn, ban.TrangThai);
            btn.Click += BanButton_Click;

            return btn;
        }

        // left click: xem chi tiết đơn; right click: menu trạng thái
        private async void BanButton_Click(object? sender, EventArgs e)
        {
            if (sender is not Button btn || btn.Tag is not BanViewModel ban) return;

            foreach (var b in panelTables.Controls.OfType<Button>())
                b.FlatAppearance.BorderSize = 2;

            btn.FlatAppearance.BorderSize = 4;
            _banDangChon = ban;

            if (Control.MouseButtons == MouseButtons.Right)
            {
                // Chuột phải: mở menu đổi trạng thái (nếu muốn dùng)
                menuTrangThai.Show(Cursor.Position);
                return;
            }

            // Chuột trái: xem chi tiết đơn + ghi chú
            await ShowOrderDetailAsync(ban);
        }

        private async Task ShowOrderDetailAsync(BanViewModel ban)
        {
            var don = ban.DonGoiDangMo;

            if (don == null)
            {
                MessageBox.Show($"{ban} hiện không có đơn đang phục vụ.",
                    "Thông tin", MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            var dsChiTiet = await _ctDonGoiService.GetByDonGoiIdAsync(don.Id);

            var sb = new StringBuilder();
            sb.AppendLine($"{ban.TenBan} - Đơn ID: {don.Id}");
            sb.AppendLine($"Mở lúc: {don.MoLuc:HH:mm dd/MM/yyyy}");
            sb.AppendLine($"Ghi chú đơn: {don.GhiChu ?? "(không)"}");
            sb.AppendLine();

            if (dsChiTiet.Count == 0)
            {
                sb.AppendLine("Chưa có món nào trong đơn.");
            }
            else
            {
                sb.AppendLine("Danh sách món:");
                int i = 1;
                foreach (var ct in dsChiTiet)
                {
                    string tenMon = "";

                    if (ct.ThucAnId.HasValue)
                        tenMon = _dsThucAn.FirstOrDefault(x => x.Id == ct.ThucAnId.Value)?.Ten ?? "Món ăn";
                    else if (ct.ThucUongId.HasValue)
                        tenMon = _dsThucUong.FirstOrDefault(x => x.Id == ct.ThucUongId.Value)?.Ten ?? "Thức uống";
                    else
                        tenMon = "Món";

                    string ghiChuMon = string.IsNullOrWhiteSpace(ct.GhiChu)
                        ? ""
                        : $" (Ghi chú: {ct.GhiChu})";

                    sb.AppendLine($"{i}. {tenMon} x{ct.SoLuong}{ghiChuMon}");
                    i++;
                }
            }

            MessageBox.Show(sb.ToString(),
                "Chi tiết đơn đang phục vụ",
                MessageBoxButtons.OK,
                MessageBoxIcon.Information);
        }

        private void MenuTrangThai_Click(object? sender, EventArgs e)
        {
            if (_banDangChon == null) return;
            if (sender is not ToolStripMenuItem item) return;
            if (item.Tag is not BanStatus newStatus) return;

            _banDangChon.TrangThai = newStatus;
            UpdateBanButton(_banDangChon);
            ApplyFilter();

            // CHÚ Ý: ở đây chỉ đổi màu ở màn hình admin,
            // không ghi lại trạng thái xuống DB.
            // Nếu muốn sync DB thì phải gọi API/Ban PUT giống FormBanHangNhanVien.
        }

        private void UpdateBanButton(BanViewModel ban)
        {
            if (_banButtons.TryGetValue(ban, out var btn))
            {
                ApplyColorByStatus(btn, ban.TrangThai);
            }
        }

        private void ApplyColorByStatus(Button btn, BanStatus status)
        {
            if (status == BanStatus.Trong)
            {
                // Bàn TRỐNG
                btn.BackColor = Color.FromArgb(240, 245, 255);
                btn.ForeColor = Color.RoyalBlue;
                btn.FlatAppearance.BorderColor = Color.RoyalBlue;
            }
            else // Đang phục vụ
            {
                btn.BackColor = Color.FromArgb(0, 120, 215);
                btn.ForeColor = Color.White;
                btn.FlatAppearance.BorderColor = Color.FromArgb(0, 120, 215);
            }
        }

        // ===========================================================
        // 4. THỐNG KÊ & NÚT FILTER
        // ===========================================================
        private void UpdateThongKeLabel(int visibleCount)
        {
            int tong = _allBans.Count;
            int soTrong = _allBans.Count(b => b.TrangThai == BanStatus.Trong);
            int soDangPhucVu = _allBans.Count(b => b.TrangThai == BanStatus.DangPhucVu);

            lblThongKe.Text =
                $"Filter: {_currentFilter} | Hiện: {visibleCount} bàn | " +
                $"Tổng: {tong} | Còn trống: {soTrong} | Đang phục vụ: {soDangPhucVu}";
        }

        private void SetActiveFilter(Button btn)
        {
            _activeFilterButton = btn;

            void Style(Button b, bool active)
            {
                b.BackColor = active ? Color.White : Color.Gainsboro;
                b.FlatStyle = FlatStyle.Flat;
                b.FlatAppearance.BorderSize = active ? 2 : 1;
                b.FlatAppearance.BorderColor = active ? Color.RoyalBlue : Color.Silver;
            }

            Style(btnFilterAll, btn == btnFilterAll);
            Style(btnFilterTrong, btn == btnFilterTrong);
            Style(btnFilterDangPhucVu, btn == btnFilterDangPhucVu);
        }

        // ===========================================================
        // 5. CHUYỂN / GỘP BÀN (DEMO – CHỈ ĐỔI MÀU LOCAL)
        // ===========================================================
        private void BtnChuyenBan_Click(object? sender, EventArgs e)
        {
            if (cboBanFrom.SelectedItem is not BanViewModel from ||
                cboBanTo.SelectedItem is not BanViewModel to)
            {
                MessageBox.Show("Chọn cả bàn nguồn và bàn đích.", "Thông báo",
                    MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            if (from.Id == to.Id)
            {
                MessageBox.Show("Bàn nguồn và bàn đích phải khác nhau.", "Thông báo",
                    MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            if (from.TrangThai != BanStatus.DangPhucVu)
            {
                MessageBox.Show("Bàn nguồn phải đang phục vụ mới chuyển được.", "Thông báo",
                    MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            if (to.TrangThai != BanStatus.Trong)
            {
                MessageBox.Show("Bàn đích phải đang trống.", "Thông báo",
                    MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            to.TrangThai = BanStatus.DangPhucVu;
            from.TrangThai = BanStatus.Trong;

            UpdateBanButton(from);
            UpdateBanButton(to);
            ApplyFilter();

            MessageBox.Show($"(Demo) Đã chuyển khách từ {from} sang {to}.",
                "Chuyển bàn", MessageBoxButtons.OK, MessageBoxIcon.Information);
        }

        private void BtnGopBan_Click(object? sender, EventArgs e)
        {
            if (cboBanFrom.SelectedItem is not BanViewModel from ||
                cboBanTo.SelectedItem is not BanViewModel to)
            {
                MessageBox.Show("Chọn cả bàn nguồn và bàn đích.", "Thông báo",
                    MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            if (from.Id == to.Id)
            {
                MessageBox.Show("Bàn nguồn và bàn đích phải khác nhau.", "Thông báo",
                    MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            if (from.TrangThai != BanStatus.DangPhucVu ||
                to.TrangThai != BanStatus.DangPhucVu)
            {
                MessageBox.Show("Gộp bàn: cả hai bàn phải đang phục vụ.", "Thông báo",
                    MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            from.TrangThai = BanStatus.Trong;

            UpdateBanButton(from);
            UpdateBanButton(to);
            ApplyFilter();

            MessageBox.Show($"(Demo) Đã gộp {from} vào {to}.",
                "Gộp bàn", MessageBoxButtons.OK, MessageBoxIcon.Information);
        }
    }

    // ====== Extension nhỏ để bật DoubleBuffer cho Control ======
    internal static class ControlExtensions
    {
        public static void DoubleBuffered(this Control control, bool enable)
        {
            var prop = typeof(Control).GetProperty("DoubleBuffered",
                System.Reflection.BindingFlags.Instance |
                System.Reflection.BindingFlags.NonPublic);
            prop?.SetValue(control, enable, null);
        }
    }
}

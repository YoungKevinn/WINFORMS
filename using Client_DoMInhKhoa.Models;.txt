using Client_DoMInhKhoa.Models;
using Client_DoMInhKhoa.Services;
using System;
using System.Collections.Generic;
using System.Drawing;
using System.Globalization;
using System.Linq;
using System.Threading.Tasks;
using System.Windows.Forms;

namespace Client_DoMInhKhoa.Forms
{
    // FORM TỰ BUILD UI = CODE (KHÔNG DÙNG DESIGNER)
    public partial class FormBanHangNhanVien : Form
    {
        // ====== TRẠNG THÁI BÀN ======
        // 0 = trống, 1 = đang dùng
        private const int STATUS_TRONG = 0;
        private const int STATUS_DANG_DUNG = 1;

        // ====== Services dùng static ApiClient ======
        private readonly DanhMucService _danhMucService = new();
        private readonly ThucAnService _thucAnService = new();
        private readonly ThucUongService _thucUongService = new();
        private readonly DonGoiService _donGoiService = new();
        private readonly ChiTietDonGoiService _ctDonGoiService = new();

        private readonly NhanVienDto _nhanVienDangNhap;

        // Cache dữ liệu
        private List<BanDto> _dsBan = new();
        private List<DanhMucDto> _dsDanhMuc = new();
        private List<ThucAnDto> _dsThucAn = new();
        private List<ThucUongDto> _dsThucUong = new();

        private BanDto? _banDangChon;
        private DonGoiDto? _donGoiHienTai;

        // id chi tiết đang chọn (để nút Xóa món dùng được)
        private int? _chiTietDangChonId;

        // ==== CONTROL UI CHÍNH ====
        // header
        private Panel _panelHeader;
        private Label lblXinChao;
        private Button btnDangXuat;

        // layout 3 cột
        private Panel _panelBan;    // cột trái: danh sách bàn
        private Panel _panelMenu;   // cột giữa: menu
        private Panel _panelDon;    // cột phải: đơn hiện tại

        // cột trái
        private FlowLayoutPanel flpBan;

        // cột giữa (menu)
        private ComboBox cboDanhMuc;
        private ComboBox cboMon;
        private NumericUpDown nudSoLuong;  // ẩn, chỉ dùng trong code
        private FlowLayoutPanel flpMonNhanh;

        // cột phải (đơn)
        private Label lblBanHienTai;
        private FlowLayoutPanel flpChiTiet; // danh sách món trong đơn (thẻ giống KiotViet)
        private Label lblTongTien;
        private Button btnThemMon;   // ẩn, chỉ dùng lại logic
        private Button btnXoaMon;
        private Button btnThanhToan;
        private ComboBox cboBanFrom;
        private ComboBox cboBanTo;
        private Button btnChuyenBan;
        private Button btnGopBan;

        // Control tạo runtime
        private TextBox? _txtTimMon;

        // ViewModel cho combobox / button món
        private class MonViewModel
        {
            public int Id { get; set; }
            public string Ten { get; set; } = string.Empty;
            public decimal DonGia { get; set; }
            public string Loai { get; set; } = string.Empty; // "ThucAn" / "ThucUong"
            public override string ToString() => Ten;
        }

        public FormBanHangNhanVien(NhanVienDto nhanVien)
        {
            _nhanVienDangNhap = nhanVien;

            BuildLayout();          // tạo 3 cột + control cơ bản
            InitExtraControls();    // ô tìm món

            // Events
            Load += FormBanHangNhanVien_Load;
            btnThemMon.Click += btnThemMon_Click;   // btn ẩn nhưng vẫn dùng logic
            btnXoaMon.Click += btnXoaMon_Click;
            btnThanhToan.Click += btnThanhToan_Click;
            btnDangXuat.Click += btnDangXuat_Click;
            btnChuyenBan.Click += btnChuyenBan_Click;
            btnGopBan.Click += btnGopBan_Click;

            cboMon.DropDownStyle = ComboBoxStyle.DropDownList;
        }

        // ================== BUILD LAYOUT 3 CỘT ==================
        private void BuildLayout()
        {
            Text = "Cafe Manager - Nhân viên";
            StartPosition = FormStartPosition.CenterScreen;
            WindowState = FormWindowState.Maximized;
            Font = new Font("Segoe UI", 9F);
            BackColor = Color.WhiteSmoke;

            // ===== HEADER =====
            _panelHeader = new Panel
            {
                Dock = DockStyle.Top,
                Height = 40,
                BackColor = Color.FromArgb(0, 120, 215)
            };

            var lblTitle = new Label
            {
                Text = "Cafe Manager - Nhân viên",
                ForeColor = Color.White,
                Dock = DockStyle.Left,
                Width = 300,
                TextAlign = ContentAlignment.MiddleLeft,
                Font = new Font("Segoe UI", 10, FontStyle.Bold),
                Padding = new Padding(10, 0, 0, 0)
            };

            lblXinChao = new Label
            {
                Text = "",
                ForeColor = Color.White,
                Dock = DockStyle.Right,
                Width = 220,
                TextAlign = ContentAlignment.MiddleRight
            };

            // ===== NÚT ĐĂNG XUẤT (CÙNG MÀU HEADER) =====
            btnDangXuat = new Button
            {
                Text = "Đăng xuất",
                Dock = DockStyle.Right,
                Width = 90,
                FlatStyle = FlatStyle.Flat,
                ForeColor = Color.White,
                BackColor = Color.FromArgb(0, 120, 215),
                UseVisualStyleBackColor = false
            };
            btnDangXuat.FlatAppearance.BorderSize = 0;
            btnDangXuat.FlatAppearance.MouseOverBackColor = Color.FromArgb(0, 100, 190);
            btnDangXuat.FlatAppearance.MouseDownBackColor = Color.FromArgb(0, 80, 160);

            _panelHeader.Controls.Add(btnDangXuat);
            _panelHeader.Controls.Add(lblXinChao);
            _panelHeader.Controls.Add(lblTitle);

            // ===== 3 CỘT CHÍNH =====
            // cột phải (đơn) thêm trước để Dock.Fill ăn đúng
            _panelDon = new Panel
            {
                Dock = DockStyle.Fill,
                Padding = new Padding(8, 12, 8, 8),
                BackColor = Color.FromArgb(255, 255, 240)
            };

            // cột giữa (menu)
            _panelMenu = new Panel
            {
                Dock = DockStyle.Left,
                Width = 420,
                Padding = new Padding(8),
                BackColor = Color.FromArgb(249, 249, 249)
            };

            // cột trái (bàn)
            _panelBan = new Panel
            {
                Dock = DockStyle.Left,
                Width = 260,
                Padding = new Padding(8),
                BackColor = Color.FromArgb(242, 242, 242)
            };

            Controls.Add(_panelDon);
            Controls.Add(_panelMenu);
            Controls.Add(_panelBan);
            Controls.Add(_panelHeader);

            BuildBanColumn();
            BuildMenuColumn();
            BuildDonColumn();
        }

        // ===== CỘT TRÁI: DANH SÁCH BÀN =====
        private void BuildBanColumn()
        {
            var lbl = new Label
            {
                Text = "Danh sách bàn",
                Dock = DockStyle.Top,
                Height = 28,
                TextAlign = ContentAlignment.MiddleLeft,
                Font = new Font("Segoe UI", 10, FontStyle.Bold)
            };

            flpBan = new FlowLayoutPanel
            {
                Dock = DockStyle.Fill,
                AutoScroll = true,
                WrapContents = true,
                Padding = new Padding(4)
            };

            _panelBan.Controls.Add(flpBan);
            _panelBan.Controls.Add(lbl);
        }

        // ===== CỘT GIỮA: MENU =====
        private void BuildMenuColumn()
        {
            var lblTitle = new Label
            {
                Text = "Menu",
                Dock = DockStyle.Top,
                Height = 26,
                TextAlign = ContentAlignment.MiddleLeft,
                Font = new Font("Segoe UI", 10, FontStyle.Bold)
            };

            var panelTop = new Panel
            {
                Dock = DockStyle.Top,
                Height = 90   // đủ chỗ cho combo + ô tìm món
            };

            var lblDm = new Label
            {
                Text = "Danh mục:",
                Location = new Point(5, 10),
                AutoSize = true
            };

            cboDanhMuc = new ComboBox
            {
                Location = new Point(80, 6),
                Width = 160,
                DropDownStyle = ComboBoxStyle.DropDownList
            };

            var lblMon = new Label
            {
                Text = "Món:",
                Location = new Point(5, 40),
                AutoSize = true
            };

            cboMon = new ComboBox
            {
                Location = new Point(80, 36),
                Width = 200,
                DropDownStyle = ComboBoxStyle.DropDownList
            };

            // NumericUpDown SL: ẩn hoàn toàn (không add label SL)
            nudSoLuong = new NumericUpDown
            {
                Location = new Point(290, 6),
                Width = 60,
                Minimum = 1,
                Maximum = 999,
                Value = 1,
                Visible = false
            };

            panelTop.Controls.Add(lblDm);
            panelTop.Controls.Add(cboDanhMuc);
            panelTop.Controls.Add(lblMon);
            panelTop.Controls.Add(cboMon);
            panelTop.Controls.Add(nudSoLuong);

            // flow món (danh sách button món)
            flpMonNhanh = new FlowLayoutPanel
            {
                Dock = DockStyle.Fill,
                AutoScroll = true,
                WrapContents = true,
                Padding = new Padding(2)
            };

            _panelMenu.Controls.Add(flpMonNhanh);
            _panelMenu.Controls.Add(panelTop);
            _panelMenu.Controls.Add(lblTitle);
        }

        // ===== CỘT PHẢI: ĐƠN HIỆN TẠI =====
        private void BuildDonColumn()
        {
            var panelTop = new Panel
            {
                Dock = DockStyle.Top,
                Height = 60
            };

            lblBanHienTai = new Label
            {
                Text = "Bàn hiện tại: (chưa chọn)",
                AutoSize = false,
                Location = new Point(5, 8),
                Size = new Size(420, 22),
                Font = new Font("Segoe UI", 10, FontStyle.Bold)
            };

            var panelButtons = new FlowLayoutPanel
            {
                Dock = DockStyle.Right,
                Width = 120,
                FlowDirection = FlowDirection.LeftToRight,
                WrapContents = false,
                Padding = new Padding(0, 8, 0, 0)
            };

            btnThemMon = new Button
            {
                Text = "Thêm món",
                Width = 90,
                Height = 30,
                Visible = false
            };

            btnXoaMon = new Button
            {
                Text = "Xóa món",
                Width = 80,
                Height = 30
            };

            panelButtons.Controls.Add(btnXoaMon);

            panelTop.Controls.Add(panelButtons);
            panelTop.Controls.Add(lblBanHienTai);

            flpChiTiet = new FlowLayoutPanel
            {
                Dock = DockStyle.Fill,
                AutoScroll = true,
                FlowDirection = FlowDirection.TopDown,
                WrapContents = false,
                Padding = new Padding(0, 4, 0, 4)
            };

            var panelBottom = new Panel
            {
                Dock = DockStyle.Bottom,
                Height = 80
            };

            var lblBanFrom = new Label
            {
                Text = "Bàn hiện tại:",
                Location = new Point(5, 10),
                AutoSize = true
            };
            cboBanFrom = new ComboBox
            {
                Location = new Point(90, 6),
                Width = 120,
                DropDownStyle = ComboBoxStyle.DropDownList
            };

            btnChuyenBan = new Button
            {
                Text = "Chuyển bàn",
                Location = new Point(220, 5),
                Size = new Size(90, 27)
            };

            var lblBanTo = new Label
            {
                Text = "Chuyển tới:",
                Location = new Point(5, 45),
                AutoSize = true
            };
            cboBanTo = new ComboBox
            {
                Location = new Point(90, 41),
                Width = 120,
                DropDownStyle = ComboBoxStyle.DropDownList
            };

            btnGopBan = new Button
            {
                Text = "Gộp bàn",
                Location = new Point(220, 40),
                Size = new Size(90, 27)
            };

            var lblTong = new Label
            {
                Text = "Tổng tiền:",
                AutoSize = true,
                Anchor = AnchorStyles.Bottom | AnchorStyles.Right,
                Location = new Point(panelBottom.Width - 260, 18)
            };
            lblTongTien = new Label
            {
                Text = "0 đ",
                AutoSize = true,
                Anchor = AnchorStyles.Bottom | AnchorStyles.Right,
                Font = new Font("Segoe UI", 11, FontStyle.Bold),
                ForeColor = Color.RoyalBlue,
                Location = new Point(panelBottom.Width - 190, 14)
            };

            btnThanhToan = new Button
            {
                Text = "Thanh toán",
                Size = new Size(110, 32),
                Anchor = AnchorStyles.Bottom | AnchorStyles.Right,
                Location = new Point(panelBottom.Width - 120, 20)
            };

            panelBottom.Resize += (s, e) =>
            {
                lblTong.Location = new Point(panelBottom.Width - 260, 18);
                lblTongTien.Location = new Point(panelBottom.Width - 190, 14);
                btnThanhToan.Location = new Point(panelBottom.Width - 120, 20);
            };

            panelBottom.Controls.Add(lblBanFrom);
            panelBottom.Controls.Add(cboBanFrom);
            panelBottom.Controls.Add(btnChuyenBan);
            panelBottom.Controls.Add(lblBanTo);
            panelBottom.Controls.Add(cboBanTo);
            panelBottom.Controls.Add(btnGopBan);
            panelBottom.Controls.Add(lblTong);
            panelBottom.Controls.Add(lblTongTien);
            panelBottom.Controls.Add(btnThanhToan);

            _panelDon.Controls.Add(flpChiTiet);
            _panelDon.Controls.Add(panelBottom);
            _panelDon.Controls.Add(panelTop);
        }

        // ================== TÌM MÓN (SEARCH) ==================
        private void InitExtraControls()
        {
            var parent = cboMon.Parent ?? this;

            var lblSearch = new Label
            {
                AutoSize = true,
                Text = "Tìm món:",
                Font = new Font("Segoe UI", 9, FontStyle.Regular)
            };
            lblSearch.Location = new Point(cboDanhMuc.Left, cboMon.Bottom + 10);

            _txtTimMon = new TextBox
            {
                Name = "txtTimMon",
                Width = 250,
                Height = cboMon.Height,
                BorderStyle = BorderStyle.FixedSingle
            };
            _txtTimMon.Location = new Point(lblSearch.Right + 5, lblSearch.Top - 3);

            _txtTimMon.TextChanged += TxtTimMon_TextChanged;

            parent.Controls.Add(lblSearch);
            parent.Controls.Add(_txtTimMon);
            lblSearch.BringToFront();
            _txtTimMon.BringToFront();
        }

        private void TxtTimMon_TextChanged(object? sender, EventArgs e)
        {
            if (cboDanhMuc.SelectedItem is DanhMucDto dm)
            {
                LoadMonTheoDanhMuc(dm, _txtTimMon?.Text);
            }

            RenderMonButtons();
        }

        // ================== LOAD FORM ==================
        private async void FormBanHangNhanVien_Load(object? sender, EventArgs e)
        {
            try { lblXinChao.Text = $"Xin chào, {_nhanVienDangNhap.HoTen}"; } catch { }

            await LoadDanhMucVaMonAsync();
            await LoadDanhSachBanAsync();
        }

        // ================== LOAD DANH MỤC + MÓN ==================
        private async Task LoadDanhMucVaMonAsync()
        {
            try
            {
                _dsDanhMuc = await _danhMucService.GetAllAsync();
                _dsThucAn = await _thucAnService.GetAllAsync();
                _dsThucUong = await _thucUongService.GetAllAsync();

                var dsDmActive = _dsDanhMuc
                    .Where(x => x.DangHoatDong)
                    .OrderBy(x => x.Ten)
                    .ToList();

                cboDanhMuc.SelectedIndexChanged -= cboDanhMuc_SelectedIndexChanged;

                cboDanhMuc.DataSource = dsDmActive;
                cboDanhMuc.DisplayMember = "Ten";
                cboDanhMuc.ValueMember = "Id";

                cboDanhMuc.SelectedIndexChanged += cboDanhMuc_SelectedIndexChanged;

                if (dsDmActive.Any())
                {
                    cboDanhMuc.SelectedIndex = 0;
                    var dm = (DanhMucDto)cboDanhMuc.SelectedItem;
                    LoadMonTheoDanhMuc(dm, _txtTimMon?.Text);
                }
                else
                {
                    cboMon.DataSource = null;
                    cboMon.Text = string.Empty;
                }

                RenderMonButtons();
            }
            catch (Exception ex)
            {
                MessageBox.Show("Lỗi khi load danh mục / món: " + ex.Message,
                    "Lỗi", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        private void cboDanhMuc_SelectedIndexChanged(object? sender, EventArgs e)
        {
            if (cboDanhMuc.SelectedItem is DanhMucDto dm)
            {
                LoadMonTheoDanhMuc(dm, _txtTimMon?.Text);
                RenderMonButtons(dm);
            }
            else
            {
                cboMon.DataSource = null;
                cboMon.Text = string.Empty;
            }
        }

        // ====== XÂY DS MÓN THEO DANH MỤC (DÙNG CHUNG) ======
        private List<MonViewModel> BuildDsMonTheoDanhMuc(DanhMucDto? dm)
        {
            var list = new List<MonViewModel>();

            var thucAn = _dsThucAn.AsEnumerable();
            var thucUong = _dsThucUong.AsEnumerable();

            if (dm != null)
            {
                thucAn = thucAn.Where(m => m.DanhMucId == dm.Id && m.DangHoatDong);
                thucUong = thucUong.Where(m => m.DanhMucId == dm.Id && m.DangHoatDong);
            }
            else
            {
                thucAn = thucAn.Where(m => m.DangHoatDong);
                thucUong = thucUong.Where(m => m.DangHoatDong);
            }

            list.AddRange(thucAn.Select(m => new MonViewModel
            {
                Id = m.Id,
                Ten = m.Ten,
                DonGia = m.DonGia,
                Loai = "ThucAn"
            }));

            list.AddRange(thucUong.Select(m => new MonViewModel
            {
                Id = m.Id,
                Ten = m.Ten,
                DonGia = m.DonGia,
                Loai = "ThucUong"
            }));

            return list.OrderBy(x => x.Ten).ToList();
        }

        // ================== FILL MÓN THEO DANH MỤC + TÌM KIẾM ==================
        private void LoadMonTheoDanhMuc(DanhMucDto dm, string? keyword = null)
        {
            var dsMon = BuildDsMonTheoDanhMuc(dm);

            if (!string.IsNullOrWhiteSpace(keyword))
            {
                var key = keyword.Trim().ToLowerInvariant();
                dsMon = dsMon
                    .Where(m => m.Ten.ToLowerInvariant().Contains(key))
                    .ToList();
            }

            if (dsMon.Count == 0)
            {
                cboMon.DataSource = null;
                cboMon.Text = string.Empty;
                return;
            }

            cboMon.DataSource = dsMon;
            cboMon.DisplayMember = "Ten";
            cboMon.ValueMember = "Id";
            cboMon.SelectedIndex = 0;
        }

        // ================== BUTTON MÓN NHANH (LIST BÊN DƯỚI) ==================
        private void RenderMonButtons(DanhMucDto? dm = null)
        {
            if (flpMonNhanh == null) return;

            flpMonNhanh.Controls.Clear();

            var dsMon = BuildDsMonTheoDanhMuc(dm);

            string keyword = _txtTimMon?.Text.Trim().ToLowerInvariant() ?? "";
            if (!string.IsNullOrEmpty(keyword))
            {
                dsMon = dsMon
                    .Where(m => m.Ten.ToLowerInvariant().Contains(keyword))
                    .ToList();
            }

            foreach (var mon in dsMon)
            {
                var btn = new Button
                {
                    Width = 120,
                    Height = 70,
                    Margin = new Padding(6),
                    Tag = mon,
                    Text = $"{mon.Ten}\n{mon.DonGia:N0}",
                    TextAlign = ContentAlignment.MiddleCenter,
                    Font = new Font("Segoe UI", 9, FontStyle.Bold),
                    BackColor = Color.FromArgb(240, 248, 255),
                    FlatStyle = FlatStyle.Flat
                };
                btn.FlatAppearance.BorderSize = 1;
                btn.FlatAppearance.BorderColor = Color.RoyalBlue;

                btn.Click += BtnMonNhanh_Click;

                flpMonNhanh.Controls.Add(btn);
            }
        }

        private void RenderMonButtons()
        {
            DanhMucDto? dm = cboDanhMuc.SelectedItem as DanhMucDto;
            RenderMonButtons(dm);
        }

        private void BtnMonNhanh_Click(object? sender, EventArgs e)
        {
            if (sender is not Button btn || btn.Tag is not MonViewModel monVm) return;

            int? dmId =
                _dsThucAn.FirstOrDefault(x => x.Id == monVm.Id)?.DanhMucId ??
                _dsThucUong.FirstOrDefault(x => x.Id == monVm.Id)?.DanhMucId;

            if (dmId.HasValue && cboDanhMuc.DataSource != null)
                cboDanhMuc.SelectedValue = dmId.Value;

            if (cboMon.DataSource is IEnumerable<MonViewModel> list)
            {
                var item = list.FirstOrDefault(x => x.Id == monVm.Id && x.Loai == monVm.Loai);
                if (item != null)
                    cboMon.SelectedItem = item;
            }

            if (nudSoLuong.Value <= 0) nudSoLuong.Value = 1;
            nudSoLuong.Value = 1;

            btnThemMon_Click(null, EventArgs.Empty);
        }

        // ================== STYLE BUTTON BÀN ==================
        private void StyleButtonBan(Button btn, int trangThai, bool isSelected = false)
        {
            btn.FlatStyle = FlatStyle.Flat;
            btn.FlatAppearance.BorderSize = isSelected ? 3 : 2;
            btn.Font = new Font("Segoe UI", 10, FontStyle.Bold);
            btn.TextAlign = ContentAlignment.MiddleCenter;

            if (trangThai == STATUS_DANG_DUNG)
            {
                btn.BackColor = Color.FromArgb(0, 120, 215);
                btn.ForeColor = Color.White;
                btn.FlatAppearance.BorderColor = Color.FromArgb(0, 120, 215);
            }
            else
            {
                btn.BackColor = Color.White;
                btn.ForeColor = Color.RoyalBlue;
                btn.FlatAppearance.BorderColor = Color.RoyalBlue;
            }
        }

        private void HighlightSelectedBan(BanDto? selected)
        {
            foreach (var control in flpBan.Controls.OfType<Button>())
            {
                if (control.Tag is not BanDto ban) continue;
                bool isSelected = (selected != null && ban.Id == selected.Id);
                StyleButtonBan(control, ban.TrangThai, isSelected);
            }
        }

        // ================== LOAD DANH SÁCH BÀN ==================
        private async Task LoadDanhSachBanAsync()
        {
            _dsBan = await BanService.GetAllAsync();

            flpBan.Controls.Clear();

            foreach (var ban in _dsBan.OrderBy(b => b.Id))
            {
                var btn = new Button
                {
                    Width = 120,
                    Height = 70,
                    Tag = ban,
                    Margin = new Padding(8),
                };

                string trangThaiText = ban.TrangThai == STATUS_DANG_DUNG
                    ? "ĐANG DÙNG"
                    : "CÒN TRỐNG";

                btn.Text = $"{ban.TenBan}\n{trangThaiText}";
                StyleButtonBan(btn, ban.TrangThai, false);
                btn.Click += BanButton_Click;

                flpBan.Controls.Add(btn);
            }

            cboBanFrom.DataSource = _dsBan.ToList();
            cboBanFrom.DisplayMember = "TenBan";
            cboBanFrom.ValueMember = "Id";

            cboBanTo.DataSource = _dsBan.ToList();
            cboBanTo.DisplayMember = "TenBan";
            cboBanTo.ValueMember = "Id";

            HighlightSelectedBan(_banDangChon);
        }

        private async void BanButton_Click(object? sender, EventArgs e)
        {
            if (sender is not Button btn || btn.Tag is not BanDto ban) return;

            _banDangChon = ban;
            cboBanFrom.SelectedValue = ban.Id;

            HighlightSelectedBan(_banDangChon);
            await LoadDonGoiChoBanAsync(ban.Id);
        }

        // ================== LOAD ĐƠN GỌI + CHI TIẾT ==================
        private async Task LoadDonGoiChoBanAsync(int banId)
        {
            var tatCaDonGoi = await _donGoiService.GetAllAsync();

            var donMoiNhat = tatCaDonGoi
                .Where(x => x.BanId == banId)
                .OrderByDescending(x => x.MoLuc)
                .FirstOrDefault();

            _donGoiHienTai = donMoiNhat;
            _chiTietDangChonId = null;

            string tenBan = _banDangChon?.TenBan
                            ?? _dsBan.FirstOrDefault(b => b.Id == banId)?.TenBan
                            ?? $"Bàn {banId}";

            if (donMoiNhat == null)
            {
                flpChiTiet.Controls.Clear();
                lblTongTien.Text = "0 đ";
                lblBanHienTai.Text = $"Bàn hiện tại: {tenBan} (chưa có đơn gọi)";
                return;
            }

            string trangThaiText = donMoiNhat.TrangThai == 1 ? "đã thanh toán" : "chưa thanh toán";
            lblBanHienTai.Text = $"Bàn hiện tại: {tenBan} ({trangThaiText})";

            var dsChiTiet = await _ctDonGoiService.GetByDonGoiIdAsync(donMoiNhat.Id);
            RenderChiTietList(dsChiTiet);
        }

        // ====== VẼ DANH SÁCH CHI TIẾT THEO KIỂU THẺ ======
        private void RenderChiTietList(List<ChiTietDonGoiDto> dsChiTiet)
        {
            flpChiTiet.SuspendLayout();
            flpChiTiet.Controls.Clear();
            decimal tong = 0;
            var vi = new CultureInfo("vi-VN");

            int index = 1;
            foreach (var ct in dsChiTiet)
            {
                string tenMon = "";
                if (ct.ThucAnId.HasValue)
                    tenMon = _dsThucAn.FirstOrDefault(x => x.Id == ct.ThucAnId.Value)?.Ten ?? "Món ăn";
                else if (ct.ThucUongId.HasValue)
                    tenMon = _dsThucUong.FirstOrDefault(x => x.Id == ct.ThucUongId.Value)?.Ten ?? "Thức uống";

                var thanhTien = ct.DonGia * ct.SoLuong;
                tong += thanhTien;

                var itemPanel = CreateChiTietItemPanel(index, tenMon, ct, vi);
                flpChiTiet.Controls.Add(itemPanel);

                index++;
            }

            flpChiTiet.ResumeLayout();

            lblTongTien.Text = string.Format(vi, "{0:N0} đ", tong);
        }

        private Panel CreateChiTietItemPanel(int index, string tenMon, ChiTietDonGoiDto ct, CultureInfo vi)
        {
            var panel = new Panel
            {
                Height = 75,
                Width = flpChiTiet.ClientSize.Width - 25,
                Margin = new Padding(0, 0, 0, 6),
                BorderStyle = BorderStyle.FixedSingle,
                BackColor = Color.White,
                Tag = ct
            };

            flpChiTiet.SizeChanged += (s, e) =>
            {
                panel.Width = flpChiTiet.ClientSize.Width - 25;
            };

            var lblTen = new Label
            {
                Text = $"{index}. {tenMon}",
                AutoSize = true,
                Location = new Point(8, 6),
                Font = new Font("Segoe UI", 10, FontStyle.Bold)
            };

            var lblGhiChuCaption = new Label
            {
                Text = "Ghi chú:",
                AutoSize = true,
                Location = new Point(18, 30),
                Font = new Font("Segoe UI", 8, FontStyle.Italic),
                ForeColor = Color.Gray
            };

            var ctLocal = ct;

            var txtGhiChu = new TextBox
            {
                BorderStyle = BorderStyle.None,
                Location = new Point(70, 30),
                Height = 16,
                Text = ct.GhiChu ?? "",
                Font = new Font("Segoe UI", 8, FontStyle.Regular),
                ForeColor = Color.Black
            };

            txtGhiChu.Width = panel.Width - 70 - 260 - 10;

            panel.Resize += (s, e) =>
            {
                txtGhiChu.Width = panel.Width - 70 - 260 - 10;
            };

            txtGhiChu.KeyDown += async (s, e) =>
            {
                if (e.KeyCode == Keys.Enter)
                {
                    e.SuppressKeyPress = true;
                    await CapNhatGhiChuChiTietAsync(ctLocal, txtGhiChu.Text.Trim());
                }
            };

            var panelRight = new Panel
            {
                Dock = DockStyle.Right,
                Width = 260
            };

            var lblDonGia = new Label
            {
                Text = ct.DonGia.ToString("N0", vi),
                AutoSize = true,
                Location = new Point(5, 8),
                Font = new Font("Segoe UI", 9)
            };

            var panelQty = new Panel
            {
                Location = new Point(70, 4),
                Size = new Size(110, 30),
                BorderStyle = BorderStyle.FixedSingle
            };

            var btnMinus = new Button
            {
                Text = "-",
                Width = 30,
                Height = 26,
                Location = new Point(0, 1),
                FlatStyle = FlatStyle.Flat
            };
            btnMinus.FlatAppearance.BorderSize = 0;

            var lblQty = new Label
            {
                Text = ct.SoLuong.ToString(),
                Width = 40,
                Height = 26,
                Location = new Point(35, 2),
                TextAlign = ContentAlignment.MiddleCenter
            };

            var btnPlus = new Button
            {
                Text = "+",
                Width = 30,
                Height = 26,
                Location = new Point(74, 1),
                FlatStyle = FlatStyle.Flat
            };
            btnPlus.FlatAppearance.BorderSize = 0;

            btnPlus.Click += async (s, e) =>
            {
                await CapNhatSoLuongChiTietAsync(ctLocal, ctLocal.SoLuong + 1);
            };

            btnMinus.Click += async (s, e) =>
            {
                if (ctLocal.SoLuong <= 1)
                {
                    if (MessageBox.Show("Giảm về 0 sẽ xóa món này. Bạn chắc chắn?",
                        "Xác nhận", MessageBoxButtons.YesNo,
                        MessageBoxIcon.Question) == DialogResult.No)
                        return;

                    await XoaChiTietAsync(ctLocal);
                }
                else
                {
                    await CapNhatSoLuongChiTietAsync(ctLocal, ctLocal.SoLuong - 1);
                }
            };

            panelQty.Controls.Add(btnMinus);
            panelQty.Controls.Add(lblQty);
            panelQty.Controls.Add(btnPlus);

            var lblThanhTien = new Label
            {
                Text = (ct.DonGia * ct.SoLuong).ToString("N0", vi),
                AutoSize = true,
                Location = new Point(190, 8),
                Font = new Font("Segoe UI", 9, FontStyle.Bold)
            };

            panelRight.Controls.Add(lblDonGia);
            panelRight.Controls.Add(panelQty);
            panelRight.Controls.Add(lblThanhTien);

            void AttachSelectHandler(Control c)
            {
                c.Click += ChiTietPanel_Click;
                foreach (Control child in c.Controls)
                {
                    AttachSelectHandler(child);
                }
            }

            AttachSelectHandler(panel);

            panel.Controls.Add(panelRight);
            panel.Controls.Add(lblTen);
            panel.Controls.Add(lblGhiChuCaption);
            panel.Controls.Add(txtGhiChu);

            return panel;
        }

        private void ChiTietPanel_Click(object? sender, EventArgs e)
        {
            Panel? panel = null;

            if (sender is Panel p1 && p1.Tag is ChiTietDonGoiDto)
                panel = p1;
            else if (sender is Control c && c.Parent is Panel p2 && p2.Tag is ChiTietDonGoiDto)
                panel = p2;

            if (panel == null || panel.Tag is not ChiTietDonGoiDto ct) return;

            _chiTietDangChonId = ct.Id;

            foreach (Panel p in flpChiTiet.Controls.OfType<Panel>())
            {
                p.BackColor = Color.White;
            }
            panel.BackColor = Color.FromArgb(230, 240, 255);
        }

        // ================== CẬP NHẬT GHI CHÚ CHI TIẾT ==================
        private async Task CapNhatGhiChuChiTietAsync(ChiTietDonGoiDto ct, string newNote)
        {
            if (_donGoiHienTai == null) return;

            var reqUpdate = new
            {
                DonGoiId = ct.DonGoiId,
                ThucAnId = ct.ThucAnId,
                ThucUongId = ct.ThucUongId,
                SoLuong = ct.SoLuong,
                DonGia = ct.DonGia,
                ChietKhau = ct.ChietKhau,
                GhiChu = string.IsNullOrWhiteSpace(newNote) ? (string?)null : newNote
            };

            await ApiClient.PutAsync<string>(
                $"api/ChiTietDonGoi/{ct.Id}",
                reqUpdate,
                includeAuth: true
            );

            await LoadDonGoiChoBanAsync(_banDangChon!.Id);
        }

        // ================== CẬP NHẬT / XOÁ CHI TIẾT ==================
        private async Task CapNhatSoLuongChiTietAsync(ChiTietDonGoiDto ct, int newSoLuong)
        {
            if (_donGoiHienTai == null) return;

            if (newSoLuong <= 0)
            {
                await XoaChiTietAsync(ct);
                return;
            }

            var reqUpdate = new
            {
                DonGoiId = ct.DonGoiId,
                ThucAnId = ct.ThucAnId,
                ThucUongId = ct.ThucUongId,
                SoLuong = newSoLuong,
                DonGia = ct.DonGia,
                ChietKhau = ct.ChietKhau,
                GhiChu = ct.GhiChu
            };

            await ApiClient.PutAsync<string>(
                $"api/ChiTietDonGoi/{ct.Id}",
                reqUpdate,
                includeAuth: true
            );

            await LoadDonGoiChoBanAsync(_banDangChon!.Id);
        }

        private async Task XoaChiTietAsync(ChiTietDonGoiDto ct)
        {
            if (_donGoiHienTai == null) return;

            await _ctDonGoiService.DeleteAsync(ct.Id);

            var dsConLai = await _ctDonGoiService.GetByDonGoiIdAsync(_donGoiHienTai.Id);

            if (dsConLai.Count == 0)
            {
                var reqCloseDon = new
                {
                    NhanVienId = _donGoiHienTai.NhanVienId,
                    BanId = _donGoiHienTai.BanId,
                    MoLuc = _donGoiHienTai.MoLuc,
                    DongLuc = DateTime.Now,
                    TrangThai = 2,
                    GhiChu = _donGoiHienTai.GhiChu
                };

                await ApiClient.PutAsync<string>(
                    $"api/DonGoi/{_donGoiHienTai.Id}",
                    reqCloseDon,
                    includeAuth: true
                );

                if (_banDangChon != null)
                {
                    _banDangChon.TrangThai = STATUS_TRONG;
                    await ApiClient.PutAsync<string>(
                        $"api/Ban/{_banDangChon.Id}",
                        _banDangChon,
                        includeAuth: true
                    );
                }

                _donGoiHienTai = null;
                _chiTietDangChonId = null;

                await LoadDanhSachBanAsync();
                flpChiTiet.Controls.Clear();
                lblTongTien.Text = "0 đ";

                string tenBan = _banDangChon?.TenBan ?? "";
                lblBanHienTai.Text = $"Bàn hiện tại: {tenBan} (chưa có đơn gọi)";
            }
            else
            {
                await LoadDonGoiChoBanAsync(_banDangChon!.Id);
            }
        }

        // ================== THÊM MÓN ==================
        private async void btnThemMon_Click(object? sender, EventArgs e)
        {
            if (_banDangChon == null)
            {
                MessageBox.Show("Vui lòng chọn bàn trong danh sách bên trái.",
                    "Thông báo", MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            if (cboMon.SelectedItem is not MonViewModel monVm)
            {
                MessageBox.Show("Vui lòng chọn món.",
                    "Thông báo", MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            int soLuong = (int)nudSoLuong.Value;
            if (soLuong <= 0)
            {
                MessageBox.Show("Số lượng phải > 0.",
                    "Thông báo", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return;
            }

            if (_donGoiHienTai == null || _donGoiHienTai.TrangThai != 0)
            {
                var reqDonGoi = new
                {
                    NhanVienId = _nhanVienDangNhap.Id,
                    BanId = _banDangChon.Id,
                    MoLuc = DateTime.Now,
                    TrangThai = 0,
                    GhiChu = (string?)null
                };
                _donGoiHienTai = await _donGoiService.CreateAsync(reqDonGoi);

                _banDangChon.TrangThai = STATUS_DANG_DUNG;
                await ApiClient.PutAsync<string>(
                    $"api/Ban/{_banDangChon.Id}",
                    _banDangChon,
                    includeAuth: true
                );

                await LoadDanhSachBanAsync();
            }
            else
            {
                if (_banDangChon.TrangThai != STATUS_DANG_DUNG)
                {
                    _banDangChon.TrangThai = STATUS_DANG_DUNG;
                    await ApiClient.PutAsync<string>(
                        $"api/Ban/{_banDangChon.Id}",
                        _banDangChon,
                        includeAuth: true
                    );
                    await LoadDanhSachBanAsync();
                }
            }

            var dsChiTietHienTai = await _ctDonGoiService.GetByDonGoiIdAsync(_donGoiHienTai!.Id);

            int? thucAnId = monVm.Loai == "ThucAn" ? monVm.Id : (int?)null;
            int? thucUongId = monVm.Loai == "ThucUong" ? monVm.Id : (int?)null;

            var existing = dsChiTietHienTai.FirstOrDefault(x =>
                x.ThucAnId == thucAnId &&
                x.ThucUongId == thucUongId &&
                x.DonGia == monVm.DonGia &&
                x.ChietKhau == 0m
            );

            if (existing != null)
            {
                await CapNhatSoLuongChiTietAsync(existing, existing.SoLuong + soLuong);
            }
            else
            {
                var reqChiTiet = new
                {
                    DonGoiId = _donGoiHienTai.Id,
                    ThucAnId = thucAnId,
                    ThucUongId = thucUongId,
                    SoLuong = soLuong,
                    DonGia = monVm.DonGia,
                    ChietKhau = 0m,
                    GhiChu = (string?)null
                };

                await _ctDonGoiService.CreateAsync(reqChiTiet);
                await LoadDonGoiChoBanAsync(_banDangChon!.Id);
            }
        }

        // ================== XÓA MÓN (THEO ITEM ĐANG CHỌN) ==================
        private async void btnXoaMon_Click(object? sender, EventArgs e)
        {
            if (_banDangChon == null || _donGoiHienTai == null)
                return;

            if (!_chiTietDangChonId.HasValue)
            {
                MessageBox.Show("Vui lòng click chọn món trong danh sách bên phải.",
                    "Thông báo", MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            if (MessageBox.Show("Xóa món đang chọn?", "Xác nhận",
                    MessageBoxButtons.YesNo, MessageBoxIcon.Question) == DialogResult.No)
                return;

            ChiTietDonGoiDto? ct = null;
            foreach (Panel p in flpChiTiet.Controls.OfType<Panel>())
            {
                if (p.Tag is ChiTietDonGoiDto ctTmp && ctTmp.Id == _chiTietDangChonId.Value)
                {
                    ct = ctTmp;
                    break;
                }
            }

            if (ct == null) return;

            await XoaChiTietAsync(ct);
        }

        // ================== THANH TOÁN ==================
        private async void btnThanhToan_Click(object? sender, EventArgs e)
        {
            if (_donGoiHienTai == null)
            {
                MessageBox.Show("Bàn này chưa có đơn gọi.",
                    "Thông báo", MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            if (_donGoiHienTai.TrangThai != 0)
            {
                MessageBox.Show("Đơn gọi đã thanh toán rồi.",
                    "Thông báo", MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            var dsChiTiet = await _ctDonGoiService.GetByDonGoiIdAsync(_donGoiHienTai.Id);
            decimal tongTien = dsChiTiet.Sum(ct => ct.DonGia * ct.SoLuong);

            MessageBox.Show($"Thanh toán {tongTien:N0} đ (bạn nối thêm API ThanhToan/HoaDon).",
                "Thanh toán", MessageBoxButtons.OK, MessageBoxIcon.Information);

            var reqCloseDon = new
            {
                NhanVienId = _donGoiHienTai.NhanVienId,
                BanId = _donGoiHienTai.BanId,
                MoLuc = _donGoiHienTai.MoLuc,
                DongLuc = DateTime.Now,
                TrangThai = 1,
                GhiChu = _donGoiHienTai.GhiChu
            };

            await ApiClient.PutAsync<string>(
                $"api/DonGoi/{_donGoiHienTai.Id}",
                reqCloseDon,
                includeAuth: true
            );

            if (_banDangChon != null)
            {
                _banDangChon.TrangThai = STATUS_TRONG;
                await ApiClient.PutAsync<string>(
                    $"api/Ban/{_banDangChon.Id}",
                    _banDangChon,
                    includeAuth: true
                );
            }

            _donGoiHienTai = null;
            _chiTietDangChonId = null;

            await LoadDanhSachBanAsync();
            await LoadDonGoiChoBanAsync(_banDangChon!.Id);
        }

        // ================== HÀM PHỤ DÙNG CHO CHUYỂN / GỘP BÀN ==================
        private async Task<DonGoiDto?> GetDonGoiDangMoTheoBanAsync(int banId)
        {
            var tatCaDonGoi = await _donGoiService.GetAllAsync();
            return tatCaDonGoi
                .Where(d => d.BanId == banId && d.TrangThai == 0)
                .OrderByDescending(d => d.MoLuc)
                .FirstOrDefault();
        }

        // ================== CHUYỂN BÀN ==================
        private async void btnChuyenBan_Click(object? sender, EventArgs e)
        {
            if (cboBanFrom.SelectedItem is not BanDto banNguon ||
                cboBanTo.SelectedItem is not BanDto banDich)
            {
                MessageBox.Show("Vui lòng chọn bàn nguồn và bàn đích.",
                    "Thông báo", MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            if (banNguon.Id == banDich.Id)
            {
                MessageBox.Show("Bàn nguồn và bàn đích phải khác nhau.",
                    "Thông báo", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return;
            }

            var donNguon = await GetDonGoiDangMoTheoBanAsync(banNguon.Id);
            if (donNguon == null)
            {
                MessageBox.Show("Bàn nguồn hiện không có đơn đang phục vụ.",
                    "Thông báo", MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            var donDich = await GetDonGoiDangMoTheoBanAsync(banDich.Id);
            if (donDich != null)
            {
                MessageBox.Show("Bàn đích đã có đơn đang phục vụ. Nếu muốn gộp, hãy dùng chức năng Gộp bàn.",
                    "Thông báo", MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            var reqUpdateDonGoi = new
            {
                NhanVienId = donNguon.NhanVienId,
                BanId = banDich.Id,
                MoLuc = donNguon.MoLuc,
                DongLuc = donNguon.DongLuc,
                TrangThai = donNguon.TrangThai,
                GhiChu = donNguon.GhiChu
            };

            await ApiClient.PutAsync<string>(
                $"api/DonGoi/{donNguon.Id}",
                reqUpdateDonGoi,
                includeAuth: true
            );

            banNguon.TrangThai = STATUS_TRONG;
            banDich.TrangThai = STATUS_DANG_DUNG;

            await ApiClient.PutAsync<string>($"api/Ban/{banNguon.Id}", banNguon, includeAuth: true);
            await ApiClient.PutAsync<string>($"api/Ban/{banDich.Id}", banDich, includeAuth: true);

            await LoadDanhSachBanAsync();

            _banDangChon = _dsBan.FirstOrDefault(b => b.Id == banDich.Id);
            if (_banDangChon != null)
            {
                HighlightSelectedBan(_banDangChon);
                await LoadDonGoiChoBanAsync(_banDangChon.Id);
            }
        }

        // ================== GỘP BÀN ==================
        private async void btnGopBan_Click(object? sender, EventArgs e)
        {
            if (cboBanFrom.SelectedItem is not BanDto banNguon ||
                cboBanTo.SelectedItem is not BanDto banDich)
            {
                MessageBox.Show("Vui lòng chọn bàn nguồn và bàn đích.",
                    "Thông báo", MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            if (banNguon.Id == banDich.Id)
            {
                MessageBox.Show("Bàn nguồn và bàn đích phải khác nhau.",
                    "Thông báo", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return;
            }

            var donNguon = await GetDonGoiDangMoTheoBanAsync(banNguon.Id);
            var donDich = await GetDonGoiDangMoTheoBanAsync(banDich.Id);

            if (donNguon == null || donDich == null)
            {
                MessageBox.Show("Cả bàn nguồn và bàn đích đều phải đang phục vụ (có đơn mở).",
                    "Thông báo", MessageBoxButtons.OK, MessageBoxIcon.Information);
                return;
            }

            if (MessageBox.Show(
                    $"Gộp tất cả món từ {banNguon.TenBan} sang {banDich.TenBan}?",
                    "Xác nhận gộp bàn",
                    MessageBoxButtons.YesNo,
                    MessageBoxIcon.Question) == DialogResult.No)
                return;

            var chiTietNguon = await _ctDonGoiService.GetByDonGoiIdAsync(donNguon.Id);

            foreach (var ct in chiTietNguon)
            {
                var reqUpdateCt = new
                {
                    DonGoiId = donDich.Id,
                    ThucAnId = ct.ThucAnId,
                    ThucUongId = ct.ThucUongId,
                    SoLuong = ct.SoLuong,
                    DonGia = ct.DonGia,
                    ChietKhau = ct.ChietKhau,
                    GhiChu = ct.GhiChu
                };

                await ApiClient.PutAsync<string>(
                    $"api/ChiTietDonGoi/{ct.Id}",
                    reqUpdateCt,
                    includeAuth: true
                );
            }

            var reqCloseDonNguon = new
            {
                NhanVienId = donNguon.NhanVienId,
                BanId = donNguon.BanId,
                MoLuc = donNguon.MoLuc,
                DongLuc = DateTime.Now,
                TrangThai = 1,
                GhiChu = donNguon.GhiChu
            };

            await ApiClient.PutAsync<string>(
                $"api/DonGoi/{donNguon.Id}",
                reqCloseDonNguon,
                includeAuth: true
            );

            banNguon.TrangThai = STATUS_TRONG;
            await ApiClient.PutAsync<string>($"api/Ban/{banNguon.Id}", banNguon, includeAuth: true);

            await LoadDanhSachBanAsync();

            _banDangChon = _dsBan.FirstOrDefault(b => b.Id == banDich.Id);
            if (_banDangChon != null)
            {
                HighlightSelectedBan(_banDangChon);
                await LoadDonGoiChoBanAsync(_banDangChon.Id);
            }
        }

        // ================== ĐĂNG XUẤT ==================
        private void btnDangXuat_Click(object? sender, EventArgs e)
        {
            Hide();
            using (var f = new FormNhanVienDangNhap())
            {
                f.ShowDialog();
            }
            Close();
        }
    }
}
